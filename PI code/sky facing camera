


def run_sky_feature_extractor(csv_path=CSV_PATH):
    
    cap = reopen_stream()
    if cap is None:
        raise RuntimeError("Could not open video stream")

    debug_log("Connected to phone sky camera.")

    # Use the passed csv_path instead of the global one, if you like
    csv_file, csv_writer = init_csv(csv_path)

    prev_gray_roi = None
    prev_time = None
    prev_optical = None
    m_per_px = None

    smooth_brightness = None
    smooth_cloud_fraction = None
    smooth_texture = None

    from collections import deque
    history = deque()
    history_max_sec = HISTORY_MAX_HOURS * 3600.0

    consecutive_errors = 0

    try:
        while True:
            loop_start = time.time()

            ret, frame = cap.read()
            if not ret:
                consecutive_errors += 1
                debug_log("Failed to grab frame. Error count:", consecutive_errors)
                if consecutive_errors > MAX_CONSECUTIVE_ERRORS:
                    debug_log("Too many errors, attempting to reopen stream...")
                    cap.release()
                    time.sleep(2)
                    cap = reopen_stream()
                    if cap is None:
                        raise RuntimeError("Could not reopen video stream after errors")
                    debug_log("Stream reopened.")
                    consecutive_errors = 0
                time.sleep(1)
                continue

            consecutive_errors = 0

            frame = cv2.resize(frame, (TARGET_WIDTH, TARGET_HEIGHT))
            gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)

            h, w = gray.shape
            roi = gray[0:int(h * ROI_TOP_FRACTION), :]

            if m_per_px is None:
                m_per_px = compute_meters_per_pixel(w, HFOV_DEG, CLOUD_HEIGHT_M)

            optical = compute_cloud_optical_features(roi)

            smooth_brightness = ema(smooth_brightness, optical["brightness"])
            smooth_cloud_fraction = ema(smooth_cloud_fraction, optical["cloud_fraction"])
            smooth_texture = ema(smooth_texture, optical["texture_index"])

            now = time.time()
            now_struct = time.localtime(now)
            timestamp_str = time.strftime("%Y-%m-%d %H:%M:%S", now_struct)

            hour_local = now_struct.tm_hour + now_struct.tm_min / 60.0
            brightness_expected = expected_clear_sky_brightness(now_struct) if USE_TIME_OF_DAY_COMP else 0.0
            brightness_anomaly = (smooth_brightness - brightness_expected) if smooth_brightness is not None else None

            features = {
                "timestamp": timestamp_str,
                "brightness": smooth_brightness,
                "contrast": optical["contrast"],
                "dark_fraction": optical["dark_fraction"],
                "cloud_fraction": smooth_cloud_fraction,
                "texture_index": smooth_texture,
                "thickness_class": optical["thickness_class"],
                "darkening_rate": None,
                "cloud_area_growth_rate": None,
                "texture_growth_rate": None,
                "vertical_growth_flag": 0,
                "cloud_vx": None,
                "cloud_vy": None,
                "cloud_speed_kmh": None,
                "cloud_direction": None,
                "hour_local": hour_local,
                "brightness_expected_clear": brightness_expected,
                "brightness_anomaly": brightness_anomaly,
                "trend20_brightness_slope": None,
                "trend20_cloud_fraction_slope": None,
                "trend20_dark_fraction_slope": None,
                "trend20_texture_slope": None,
            }

            if prev_optical is not None and prev_time is not None:
                dt_sec = now - prev_time
                dt_min = dt_sec / 60.0

                dr, ca_gr, tx_gr, vflag = compute_vertical_growth(prev_optical, optical, dt_min)
                features["darkening_rate"] = dr
                features["cloud_area_growth_rate"] = ca_gr
                features["texture_growth_rate"] = tx_gr
                features["vertical_growth_flag"] = int(vflag)

            if prev_gray_roi is not None and prev_time is not None:
                dt_sec = now - prev_time
                mean_vx, mean_vy, direction, km_per_h, px_per_sec = compute_flow(
                    prev_gray_roi, roi, dt_sec, m_per_px
                )
                if direction is not None:
                    features["cloud_vx"] = mean_vx
                    features["cloud_vy"] = mean_vy
                    features["cloud_speed_kmh"] = km_per_h
                    features["cloud_direction"] = direction

            history.append({
                "epoch": now,
                "brightness": features["brightness"],
                "cloud_fraction": features["cloud_fraction"],
                "dark_fraction": features["dark_fraction"],
                "texture_index": features["texture_index"],
            })

            while history and (now - history[0]["epoch"] > history_max_sec):
                history.popleft()

            b_slope, cf_slope, df_slope, tx_slope = compute_trend_over_window(
                history, now, TREND_WINDOW_MIN
            )
            features["trend20_brightness_slope"] = b_slope
            features["trend20_cloud_fraction_slope"] = cf_slope
            features["trend20_dark_fraction_slope"] = df_slope
            features["trend20_texture_slope"] = tx_slope

            csv_writer.writerow([
                features["timestamp"],
                features["brightness"],
                features["contrast"],
                features["dark_fraction"],
                features["cloud_fraction"],
                features["texture_index"],
                features["thickness_class"],
                features["darkening_rate"],
                features["cloud_area_growth_rate"],
                features["texture_growth_rate"],
                features["vertical_growth_flag"],
                features["cloud_vx"],
                features["cloud_vy"],
                features["cloud_speed_kmh"],
                features["cloud_direction"],
                features["hour_local"],
                features["brightness_expected_clear"],
                features["brightness_anomaly"],
                features["trend20_brightness_slope"],
                features["trend20_cloud_fraction_slope"],
                features["trend20_dark_fraction_slope"],
                features["trend20_texture_slope"],
            ])
            csv_file.flush()

            prev_gray_roi = roi.copy()
            prev_optical = optical
            prev_time = now

            elapsed = time.time() - loop_start
            sleep_time = SAMPLE_INTERVAL_SEC - elapsed
            if sleep_time > 0:
                time.sleep(sleep_time)

    finally:
        if cap is not None:
            cap.release()
        csv_file.close()

    # Let caller know which CSV file has the data
    return csv_path


if __name__ == "__main__":
    # When run directly, just start the extractor and ignore the return value.
    run_sky_feature_extractor()
